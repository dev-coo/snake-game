<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WebSocket ì—°ê²° í…ŒìŠ¤íŠ¸</title>
  <style>
    body {
      font-family: monospace;
      padding: 20px;
      background: #1a1a1a;
      color: #00ff00;
    }
    button {
      background: #333;
      color: #00ff00;
      border: 1px solid #00ff00;
      padding: 10px 20px;
      margin: 10px;
      cursor: pointer;
    }
    button:hover {
      background: #444;
    }
    #log {
      background: #000;
      padding: 10px;
      border: 1px solid #00ff00;
      height: 400px;
      overflow-y: scroll;
      margin-top: 20px;
    }
    .error {
      color: #ff0066;
    }
    .success {
      color: #00ff00;
    }
    .info {
      color: #ffcc00;
    }
  </style>
</head>
<body>
  <h1>ğŸ® Snake Battle - WebSocket ì—°ê²° í…ŒìŠ¤íŠ¸</h1>
  
  <div>
    <p class="info">í˜„ì¬ í˜ì´ì§€ URL: <span id="pageUrl"></span></p>
    <p class="info">ê°ì§€ëœ ì„œë²„ URL: <span id="serverUrl"></span></p>
  </div>
  
  <div>
    <button onclick="testConnection()">ì—°ê²° í…ŒìŠ¤íŠ¸</button>
    <button onclick="testWithCustomUrl()">ì»¤ìŠ¤í…€ URL í…ŒìŠ¤íŠ¸</button>
    <button onclick="testHealthCheck()">Health Check</button>
    <button onclick="testDirectSocket()">Direct Socket.io</button>
    <button onclick="clearLog()">ë¡œê·¸ ì§€ìš°ê¸°</button>
  </div>
  
  <div>
    <input type="text" id="customUrl" placeholder="ì„œë²„ URL (ì˜ˆ: http://example.com:3001)" style="width: 300px; padding: 5px;">
  </div>
  
  <div id="log"></div>
  
  <script src="/socket.io/socket.io.js"></script>
  <script>
    const logDiv = document.getElementById('log');
    const pageUrlSpan = document.getElementById('pageUrl');
    const serverUrlSpan = document.getElementById('serverUrl');
    
    // í˜„ì¬ í˜ì´ì§€ ì •ë³´ í‘œì‹œ
    pageUrlSpan.textContent = window.location.href;
    
    // ì„œë²„ URL ìë™ ê°ì§€
    function getServerUrl() {
      const protocol = window.location.protocol;
      const hostname = window.location.hostname;
      
      if (hostname === 'localhost' || hostname === '127.0.0.1') {
        return 'http://localhost:3001';
      } else {
        return `${protocol}//${hostname}:3001`;
      }
    }
    
    serverUrlSpan.textContent = getServerUrl();
    
    function log(message, type = 'info') {
      const time = new Date().toLocaleTimeString();
      const entry = document.createElement('div');
      entry.className = type;
      entry.textContent = `[${time}] ${message}`;
      logDiv.appendChild(entry);
      logDiv.scrollTop = logDiv.scrollHeight;
    }
    
    function testConnection() {
      const serverUrl = getServerUrl();
      log(`í…ŒìŠ¤íŠ¸ ì‹œì‘: ${serverUrl}`, 'info');
      
      const socket = io(serverUrl, {
        transports: ['websocket', 'polling'],
        reconnection: false,
        timeout: 10000,
        forceNew: true,
      });
      
      socket.on('connect', () => {
        log('âœ… ì—°ê²° ì„±ê³µ!', 'success');
        log(`Socket ID: ${socket.id}`, 'success');
        
        // ì—°ê²° ì„±ê³µ í›„ ë°”ë¡œ ëŠê¸°
        setTimeout(() => {
          socket.disconnect();
          log('ì—°ê²° ì¢…ë£Œ', 'info');
        }, 1000);
      });
      
      socket.on('connect_error', (error) => {
        log(`âŒ ì—°ê²° ì‹¤íŒ¨: ${error.message}`, 'error');
        log(`Error type: ${error.type}`, 'error');
      });
      
      socket.on('error', (error) => {
        log(`âŒ ì—ëŸ¬: ${error}`, 'error');
      });
    }
    
    function testWithCustomUrl() {
      const customUrl = document.getElementById('customUrl').value;
      if (!customUrl) {
        log('URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”', 'error');
        return;
      }
      
      log(`ì»¤ìŠ¤í…€ URL í…ŒìŠ¤íŠ¸: ${customUrl}`, 'info');
      
      const socket = io(customUrl, {
        transports: ['websocket', 'polling'],
        reconnection: false,
        timeout: 10000,
        forceNew: true,
      });
      
      socket.on('connect', () => {
        log('âœ… ì»¤ìŠ¤í…€ URL ì—°ê²° ì„±ê³µ!', 'success');
        log(`Socket ID: ${socket.id}`, 'success');
        
        setTimeout(() => {
          socket.disconnect();
          log('ì—°ê²° ì¢…ë£Œ', 'info');
        }, 1000);
      });
      
      socket.on('connect_error', (error) => {
        log(`âŒ ì»¤ìŠ¤í…€ URL ì—°ê²° ì‹¤íŒ¨: ${error.message}`, 'error');
      });
    }
    
    function clearLog() {
      logDiv.innerHTML = '';
      log('ë¡œê·¸ ì§€ì›€', 'info');
    }
    
    function testHealthCheck() {
      const serverUrl = getServerUrl();
      const healthUrl = `${serverUrl}/health`;
      log(`Health check: ${healthUrl}`, 'info');
      
      fetch(healthUrl)
        .then(response => {
          log(`HTTP Status: ${response.status}`, response.ok ? 'success' : 'error');
          return response.json();
        })
        .then(data => {
          log(`âœ… Health check ì„±ê³µ: ${JSON.stringify(data)}`, 'success');
        })
        .catch(error => {
          log(`âŒ Health check ì‹¤íŒ¨: ${error.message}`, 'error');
        });
    }
    
    function testDirectSocket() {
      const serverUrl = getServerUrl();
      log(`Direct Socket.io í…ŒìŠ¤íŠ¸: ${serverUrl}`, 'info');
      
      // Socket.io ì—†ì´ ì§ì ‘ WebSocket í…ŒìŠ¤íŠ¸
      try {
        const wsUrl = serverUrl.replace('http:', 'ws:').replace('https:', 'wss:');
        const ws = new WebSocket(`${wsUrl}/socket.io/?EIO=4&transport=websocket`);
        
        ws.onopen = () => {
          log('âœ… WebSocket ì§ì ‘ ì—°ê²° ì„±ê³µ!', 'success');
          ws.close();
        };
        
        ws.onerror = (error) => {
          log(`âŒ WebSocket ì§ì ‘ ì—°ê²° ì‹¤íŒ¨`, 'error');
        };
        
        ws.onclose = () => {
          log('WebSocket ì—°ê²° ì¢…ë£Œ', 'info');
        };
      } catch (error) {
        log(`âŒ WebSocket ìƒì„± ì‹¤íŒ¨: ${error.message}`, 'error');
      }
    }
    
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ í…ŒìŠ¤íŠ¸
    window.onload = () => {
      log('í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ', 'info');
      log(`ë¸Œë¼ìš°ì €: ${navigator.userAgent}`, 'info');
    };
  </script>
</body>
</html>