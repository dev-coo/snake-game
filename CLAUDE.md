# Snake Battle 프로젝트 정보

## 프로젝트 개요
- **프로젝트명**: Snake Battle - 1:1 온라인 스네이크 게임
- **기술 스택**: React + TypeScript + Phaser 3 + Socket.io + Node.js
- **구조**: Monorepo (client, server, shared)
- **GitHub**: https://github.com/dev-coo/snake-game

## 현재 구현 상태 (2025-09-08 업데이트)

### ✅ 완료된 기능
1. **프로젝트 구조 설정**
   - Monorepo 구조 (npm workspaces)
   - TypeScript, ESLint, Prettier 설정
   - Jest 테스트 환경 구성

2. **게임 엔진 구현**
   - Phaser 3 기반 게임 씬 구조
   - Snake, Food 엔티티 클래스 (100% 테스트 커버리지)
   - 충돌 감지 시스템 (벽, 자기 자신, 먹이)
   - 입력 처리 시스템 (WASD, 방향키)
   - 입력 큐잉 시스템 (빠른 입력 시 자기 충돌 방지)

3. **UI/UX 구현**
   - MainMenu: 시작 화면, 플레이어 이름 입력
   - GameContainer: Phaser-React 통합
   - GameUI: 실시간 점수, 시간 표시
   - GameOverModal: 게임 종료 화면, 사망 원인 표시
   - localStorage: 플레이어 이름 저장

4. **상태 관리**
   - Zustand 스토어 구성
   - 게임 상태, 플레이어 정보, 사망 원인 관리

5. **멀티플레이어 기능**
   - Express + Socket.io 서버 구축 완료
   - 룸 생성/참가/대기실 시스템
   - 실시간 게임 상태 동기화
   - NetworkService 클라이언트 통신
   - MultiplayerGameScene 구현

6. **멀티플레이어 게임 종료**
   - 승패 결과 명확히 표시 (승리/패배)
   - 사망 원인 표시 (벽/자기 몸/상대방 충돌)
   - 재경기 요청/취소 시스템
   - 실제 점수 표시 및 상대방 점수 비교

### 🆕 오늘 추가된 기능 (2025-09-08)

1. **재경기 시스템 개선**
   - 플레이어 ID 정렬 로직으로 일관된 위치 보장
   - 플레이어 퇴장 시 재경기 상태 초기화
   - 플레이어 수 검증 (2명일 때만 재경기 시작)

2. **게임 시작 개선**
   - 3초 카운트다운 추가 (3, 2, 1, GO!)
   - 클라이언트 로딩 시간 보장
   - 페이드 아웃 애니메이션 효과

3. **네트워크 접속 개선**
   - 0.0.0.0 바인딩으로 모든 인터페이스 접속 허용
   - 단일 포트(3000)로 프록시 설정
   - 포트포워딩 설정 간소화 (3000 포트만 필요)
   - 동적 서버 URL 감지

4. **디버깅 도구 추가**
   - `/debug.html` WebSocket 연결 테스트 페이지
   - 상세한 연결 로그 출력
   - Health check 엔드포인트

### 🚧 진행 예정 작업

#### 1차 개발 (핵심 기능)
1. **서버 구축**
   - [x] Express 서버 기본 설정
   - [x] Socket.io 실시간 통신 설정
   - [x] 룸 생성/참가 시스템
   - [x] 게임 상태 동기화 로직
   - [ ] Redis 세션 관리

2. **멀티플레이어 기능**
   - [x] 네트워크 서비스 클래스 구현
   - [x] 서버-클라이언트 프로토콜 정의
   - [x] 실시간 위치 동기화
   - [ ] 지연 보상 및 예측
   - [ ] 연결 끊김 처리

3. **게임 개선**
   - [ ] 점수 시스템 실제 연동
   - [ ] 게임 통계 수집 (먹은 먹이 수, 최대 길이 등)
   - [ ] 시간 제한 기능 구현
   - [ ] 음향 효과 추가

4. **배포 준비**
   - [ ] 환경 변수 설정
   - [ ] 프로덕션 빌드 최적화
   - [ ] Docker 컨테이너화
   - [ ] CI/CD 파이프라인

#### 2차 개발 (확장 기능)
1. **특수 아이템**
   - [ ] 황금 먹이, 속도 증가/감소, 무적 아이템
   - [ ] 아이템 효과 시각화
   - [ ] 배틀 모드 전용 기능

2. **매칭 시스템**
   - [ ] 자동 매칭 큐
   - [ ] 스킬 기반 매칭
   - [ ] 리더보드

3. **추가 기능**
   - [ ] 3-4인 대전 모드
   - [ ] 맵 테마 선택
   - [ ] 스네이크 스킨 커스터마이징
   - [ ] 관전 모드

## 주요 파일 구조
```
snake-game/
├── client/
│   ├── src/
│   │   ├── components/      # React UI 컴포넌트
│   │   ├── game/           # Phaser 게임 로직
│   │   │   ├── entities/   # Snake, Food 클래스
│   │   │   ├── scenes/     # GameScene
│   │   │   └── config/     # 게임 설정
│   │   └── store/          # Zustand 상태 관리
├── server/                 # Node.js 백엔드
│   ├── src/
│   │   ├── controllers/    # SocketController
│   │   ├── services/       # RoomService, GameService
│   │   └── index.ts        # 서버 진입점
├── shared/                 # 공유 타입 및 상수
└── docs/                   # 프로젝트 문서
```

## 최근 해결된 이슈들 (2025-09-08)
1. **재경기 시 플레이어2 뱀 미표시**: 씬 초기화 로직 추가
2. **플레이어 퇴장 후 재경기 버그**: 재경기 상태 초기화 로직 추가
3. **포트포워딩 문제**: 단일 포트(3000) 프록시 설정으로 해결
4. **WebSocket 연결 실패**: 동적 URL 감지 및 프록시 설정

## 이전 해결된 이슈들
1. **UI 위치 버그**: fixed position 및 캔버스 크기 고정으로 해결
2. **벽 충돌 버그**: 초기 위치 조정 및 충돌 검사 타이밍 개선
3. **자기 충돌 버그**: 입력 큐잉 시스템으로 해결
4. **자동 화면 전환**: 사용자 선택 대기로 변경
5. **사망 원인 표시**: 벽/자신의 몸 구분하여 표시
6. **모듈 시스템 오류**: shared 패키지 CommonJS로 변경
7. **Map 직렬화 오류**: JSON.parse/stringify로 해결
8. **positions 배열 오류**: Snake 클래스 중복 메서드 제거
9. **게임 종료 시 UI 미표시**: App.tsx finished 상태 처리 추가

## 개발 명령어
```bash
# 루트 폴더에서 실행
npm install              # 패키지 설치
npm run dev:client       # 클라이언트만 실행
npm run dev:server       # 서버만 실행 (미구현)
npm run dev             # 둘 다 실행
npm test                # 테스트 실행
npm run build           # 프로덕션 빌드
```

## 다음 작업 우선순위 (TODO)

### 🔥 긴급 (버그 수정)
없음 - 주요 버그 해결 완료

### ⚡ 높은 우선순위
1. **머리 충돌 시 무승부 처리 구현**
   - 두 뱀의 머리가 정확히 같은 위치에 도달하면 무승부 처리
   - GameService의 충돌 감지 로직 수정 필요
   - 무승부 시 별도의 UI 표시

### 📊 중간 우선순위
1. **게임 통계 및 점수 시스템 완성**
   - 먹은 먹이 수, 최대 길이 추적
   - 게임 시간 측정 및 표시
   - 통계 데이터 GameOverModal에 연동

2. **시간 제한 기능 구현**
   - 클래식 모드 3분, 배틀 모드 5분 제한
   - 시간 초과 시 점수 높은 플레이어 승리
   - UI에 남은 시간 표시

3. **음향 효과 추가**
   - 먹이 획득, 충돌, 카운트다운 사운드
   - 배경 음악 (on/off 토글)

### 🔧 낮은 우선순위
1. **WebSocket 바이너리 프로토콜 변경**
   - Socket.io의 바이너리 전송 모드 활성화
   - 게임 상태 직렬화 최적화
   - 네트워크 트래픽 감소 효과

2. **연결 끊김 처리 및 재접속**
   - 일시적 연결 끊김 시 게임 일시정지
   - 재접속 타임아웃 설정
   - 연결 상태 UI 표시

### 🎯 향후 확장 기능
1. **특수 아이템 시스템**
   - 황금 먹이 (3배 점수)
   - 속도 증가/감소 아이템
   - 무적 아이템 (5초간)
   - 상대방 조작 반전

2. **매칭 시스템**
   - 자동 매칭 큐
   - 스킬 기반 매칭 (ELO 레이팅)
   - 리더보드 및 시즌 시스템

3. **게임 모드 확장**
   - 3-4인 대전 모드
   - 팀전 모드 (2v2)
   - 서바이벌 모드 (무한 웨이브)
   - 커스텀 맵 에디터

4. **시각적 개선**
   - 스네이크 스킨 커스터마이징
   - 맵 테마 선택 (사막, 우주, 정글 등)
   - 파티클 효과 강화
   - 관전 모드

## 접속 방법

### 로컬 개발
```bash
npm run dev
# http://localhost:3000
```

### 외부 네트워크 접속 (포트포워딩)
1. 라우터에서 3000 포트만 포트포워딩
2. `http://[공인IP]:3000` 접속
3. 자세한 내용은 `ONE_PORT_SETUP.md` 참조

## 참고사항
- 게임 속도: NORMAL = 150ms
- 맵 크기: 40x40 격자
- 캔버스 크기: 600x600px
- 시간 제한: 클래식 3분, 배틀 5분

## 주의사항
- **서버는 CommonJS 모듈 시스템 사용**: require/module.exports 사용
- **shared 패키지도 CommonJS로 빌드**: ESM 사용 시 서버에서 ERR_REQUIRE_ESM 오류 발생
- shared/tsconfig.json에 `"module": "commonjs"` 설정 필요
- shared/package.json에 `"type": "module"` 제거 필요